from datetime import datetime
from helpers import obfuscate_prompt_username
import config

PAGINATION_ROW_COUNT = 25

class Message(config.db.Model):
  """Keeps track of all messages generated by Luna on Twitch."""

  id = config.db.Column(
    config.db.Integer,
    primary_key=True,
    autoincrement=True
  )
  created_at = config.db.Column(
    config.db.DateTime,
    nullable=False,
    default=datetime.now
  )
  prompt = config.db.Column(
    config.db.Text,
    nullable=False
  )
  response = config.db.Column(
    config.db.Text,
    nullable=False
  )
  latency_llm = config.db.Column(
    config.db.Float,
    nullable=False,
  )
  latency_tts = config.db.Column(
    config.db.Float,
    nullable=False,
  )
class MessageSchema(config.ma.SQLAlchemySchema):
  class Meta:
    model = Message
  id=config.ma.auto_field()
  created_at=config.ma.auto_field()
  prompt=config.ma.auto_field()
  response=config.ma.auto_field()
  latency_llm=config.ma.auto_field()
  latency_tts=config.ma.auto_field()
message_schema = MessageSchema()
messages_schema = MessageSchema(many=True)
def db_message_get_by_page(page):
  rows = Message.query.offset((page - 1) * PAGINATION_ROW_COUNT).limit(PAGINATION_ROW_COUNT).all()
  return messages_schema.dump(rows)
def db_message_insert_one(prompt, response, latency_llm, latency_tts):
  row = Message(
    prompt=obfuscate_prompt_username(prompt),
    response=response,
    latency_llm=latency_llm,
    latency_tts=latency_tts
  )
  config.db.session.add(row)
  config.db.session.commit()

class Event(config.db.Model):
  """Keeps track of twitch event usage, such as channel point redemptions & chat commands."""

  id = config.db.Column(
    config.db.Integer,
    primary_key=True,
    autoincrement=True
  )
  created_at = config.db.Column(
    config.db.DateTime,
    nullable=False,
    default=datetime.now
  )
  type = config.db.Column(
    config.db.Text, # should ideally be enum based on TWITCH_EVENT_TYPE
    nullable=False
  )
  event = config.db.Column(
    config.db.Text,
    nullable=False
  )
  body = config.db.Column(
    config.db.Text,
    nullable=False
  )
class EventSchema(config.ma.SQLAlchemySchema):
  class Meta:
    model = Event
  id=config.ma.auto_field()
  created_at=config.ma.auto_field()
  type=config.ma.auto_field()
  event=config.ma.auto_field()
  body=config.ma.auto_field()
event_schema = EventSchema()
events_schema = EventSchema(many=True)
def db_event_get_by_page(page):
  rows = Event.query.offset((page - 1) * PAGINATION_ROW_COUNT).limit(PAGINATION_ROW_COUNT).all()
  return events_schema.dump(rows)
def db_event_insert_one(type, event, body):
  row = Event(
    type=type,
    event=event,
    body=body
  )
  config.db.session.add(row)
  config.db.session.commit()

# create database
with config.app.app_context():
  config.db.create_all()
